<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Flower Crown Eevee" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="A full belly conquers all.">
<meta property="og:type" content="website">
<meta property="og:title" content="Flower Crown Eevee">
<meta property="og:url" content="http://eevee.cc/index.html">
<meta property="og:site_name" content="Flower Crown Eevee">
<meta property="og:description" content="A full belly conquers all.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Flower Crown Eevee">
<meta name="twitter:description" content="A full belly conquers all.">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6273277081015027000,
      author: 'Eevee'
    }
  };
</script>

  <title> Flower Crown Eevee </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=55592908";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Flower Crown Eevee</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/06/using-djinni/" itemprop="url">
                  使用 Djinni 开发 Android, iOS 共享库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-06T15:30:41+08:00" content="2016-05-06">
              2016-05-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Tech/" itemprop="url" rel="index">
                    <span itemprop="name">Tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/06/using-djinni/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/06/using-djinni/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" target="_blank" rel="external">署名-非商业性使用-禁止演绎 4.0 国际 (CC BY-NC-ND 4.0)</a></p>
</blockquote>

<style type="text/css">
.post-body .fancybox img {
    margin: 0 auto 25px;
}
</style>

<p><a href="https://github.com/dropbox/djinni" target="_blank" rel="external">Djinni</a> 是一个用来生成跨语言的类型声明和接口绑定的工具，主要用于 C++ 和 Java 以及 Objective-C 间的互通。</p>
<p>此文，将介绍如何使用 <a href="https://github.com/dropbox/djinni" target="_blank" rel="external">Djinni</a> 开发 Android, iOS 的共享库。这会带来几个好处：</p>
<ul>
<li>用了接口描述文件。声明清晰、修改简易，并保证了跨平台接口的一致性。</li>
<li>自动生成接口绑定代码。免去了绑定 C++ 和 Java (JNI) 及 Objective-C (Objective-C++) 的麻烦。</li>
</ul>
<h2 id="初见：Djinni-及其样例"><a href="#初见：Djinni-及其样例" class="headerlink" title="初见：Djinni 及其样例"></a>初见：Djinni 及其样例</h2><h3 id="下载-Djinni"><a href="#下载-Djinni" class="headerlink" title="下载 Djinni"></a>下载 Djinni</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/dropbox/djinni.git</span><br></pre></td></tr></table></figure>
<h3 id="编译-Djinni"><a href="#编译-Djinni" class="headerlink" title="编译 Djinni"></a>编译 Djinni</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> [djinni_root]/</span><br><span class="line">$ src/build</span><br></pre></td></tr></table></figure>
<p>于<code>[djinni_root]/src/support/sbt.resolvers.properties</code>内可添加镜像源。</p>
<ul>
<li><a href="http://www.zhihu.com/question/31158252" target="_blank" rel="external">sbt下载慢？</a></li>
</ul>
<h3 id="使用-Djinni"><a href="#使用-Djinni" class="headerlink" title="使用 Djinni"></a>使用 Djinni</h3><p>生成样例接口代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> [djinni_root]/example/  <span class="comment"># example_root</span></span><br><span class="line">$ ./run_djinni.sh</span><br></pre></td></tr></table></figure>
<p>即会生成到<code>djinni-output-temp</code>临时目录，最终复制到<code>generated-src</code>生成目录。</p>
<p>这里可以看到：依据描述文件<code>example.djinni</code>，C++ 和 Java 及 Objective-C 的绑定代码都会自动生成好。继续要做的，只是写它们的具体实现，见样例的<code>handwritten-src</code>目录。</p>
<p>如果要清除输出目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./run_djinni.sh clean</span><br></pre></td></tr></table></figure>
<h3 id="编译样例"><a href="#编译样例" class="headerlink" title="编译样例"></a>编译样例</h3><p><code>[djinni_root]/Makefile</code>已配置好了依赖，执行相应目标即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> [djinni_root]/</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：下载好 Djinni ，即可开始编译样例了。</p>
</blockquote>
<p>编译 Android 工程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make example_android</span><br></pre></td></tr></table></figure>
<p>样例的 Android 工程在<code>[example_root]/android</code>目录， 动态库生成在<code>[example_root]/android/app/libs</code>目录。或者，利用 Android Studio / Gradle 来运行编译。</p>
<p>编译 iOS 工程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make example_ios</span><br></pre></td></tr></table></figure>
<p>样例的 iOS 工程在<code>[example_root]/objc</code>目录， lib 工程生成在<code>[djinni_root]\build_ios</code>目录。然后，可以打开<code>[example_root]/objc/TextSort.xcworkspace</code>来运行编译。</p>
<p>如果要清理工程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make clean</span><br></pre></td></tr></table></figure>
<h3 id="准备-GYP"><a href="#准备-GYP" class="headerlink" title="准备 GYP"></a>准备 GYP</h3><p>编译样例时， Android NDK 与 iOS 的 Library 工程都需依赖 GYP 生成。 make 时，会自行 clone 到<code>[djinni_root]/deps/gyp</code>目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://chromium.googlesource.com/external/gyp.git</span><br></pre></td></tr></table></figure>
<p>GYP 生成 Android Makefile 时，目前会遇到如下错误：</p>
<blockquote>
<p>ImportError: No module named android</p>
</blockquote>
<p>所以，需要切换到旧版本。此后的那个 commit 移除了 Android 的生成器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd gyp/</span><br><span class="line">$ git checkout -q 0bb67471bca068996e15b56738fa4824dfa19de0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：<a href="https://github.com/dropbox/djinni/issues/87" target="_blank" rel="external">Stop using gyp’s android generator</a></p>
</blockquote>
<h2 id="从无到有：Hello-Djinni"><a href="#从无到有：Hello-Djinni" class="headerlink" title="从无到有：Hello Djinni"></a>从无到有：Hello Djinni</h2><h3 id="C-接口"><a href="#C-接口" class="headerlink" title="C++ 接口"></a>C++ 接口</h3><h4 id="定义接口描述文件"><a href="#定义接口描述文件" class="headerlink" title="定义接口描述文件"></a>定义接口描述文件</h4><figure class="highlight bash"><figcaption><span>hellodjinni.djinni</span><a href="https://github.com/joinAero/XCalculator/blob/master/sample/hellodjinni/hellodjinni.djinni" target="_blank" rel="external">hellodjinni.djinni</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hello_djinni = interface +c &#123;</span><br><span class="line">    static create(): hello_djinni;</span><br><span class="line">    get_hello_djinni(): string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="生成接口绑定代码"><a href="#生成接口绑定代码" class="headerlink" title="生成接口绑定代码"></a>生成接口绑定代码</h4><p>写了个简单的 Shell 脚本来执行 Djinni 命令，如下：</p>
<figure class="highlight bash"><figcaption><span>run_djinni.sh:</span><a href="https://github.com/joinAero/XCalculator/blob/master/sample/hellodjinni/run_djinni.sh" target="_blank" rel="external">run_djinni.sh</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> <span class="_">-e</span></span><br><span class="line"><span class="built_in">shopt</span> <span class="_">-s</span> nullglob</span><br><span class="line"></span><br><span class="line">base_dir=$(<span class="built_in">cd</span> <span class="string">"`dirname "</span><span class="variable">$0</span><span class="string">"`"</span> &amp;&amp; <span class="built_in">pwd</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read local properties</span></span><br><span class="line"><span class="built_in">eval</span> $(cat <span class="variable">$base_dir</span>/local.properties | sed <span class="string">'s/&lt;[^&gt;]*&gt;//g'</span> | sed <span class="string">'s/\./_/g'</span>)</span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="variable">$djinni_dir</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Unspecified djinni.dir in local.properties"</span> 1&gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">out_dir=<span class="string">"<span class="variable">$base_dir</span>/generated-src"</span></span><br><span class="line"></span><br><span class="line">cpp_out=<span class="string">"<span class="variable">$out_dir</span>/cpp"</span></span><br><span class="line">jni_out=<span class="string">"<span class="variable">$out_dir</span>/jni"</span></span><br><span class="line">objc_out=<span class="string">"<span class="variable">$out_dir</span>/objc"</span></span><br><span class="line">java_out=<span class="string">"<span class="variable">$out_dir</span>/java/cc/eevee/hellodjinni"</span></span><br><span class="line"></span><br><span class="line">java_package=<span class="string">"cc.eevee.hellodjinni"</span></span><br><span class="line">cpp_namespace=<span class="string">"hellodjinni"</span></span><br><span class="line">objc_<span class="built_in">type</span>_prefix=<span class="string">"HD"</span></span><br><span class="line">djinni_file=<span class="string">"<span class="variable">$base_dir</span>/hellodjinni.djinni"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[[ <span class="_">-e</span> <span class="variable">$out_dir</span> ]] &amp;&amp; rm -rf <span class="variable">$out_dir</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$djinni_dir</span>/src/run-assume-built \</span><br><span class="line">    --java-out <span class="variable">$java_out</span> \</span><br><span class="line">    --java-package <span class="variable">$java_package</span> \</span><br><span class="line">    --ident-java-field mFooBar \</span><br><span class="line">    \</span><br><span class="line">    --cpp-out <span class="variable">$cpp_out</span> \</span><br><span class="line">    --cpp-namespace <span class="variable">$cpp_namespace</span> \</span><br><span class="line">    \</span><br><span class="line">    --jni-out <span class="variable">$jni_out</span> \</span><br><span class="line">    --ident-jni-class NativeFooBar \</span><br><span class="line">    --ident-jni-file NativeFooBar \</span><br><span class="line">    \</span><br><span class="line">    --objc-out <span class="variable">$objc_out</span> \</span><br><span class="line">    --objcpp-out <span class="variable">$objc_out</span> \</span><br><span class="line">    --objc-type-prefix <span class="variable">$objc_type_prefix</span> \</span><br><span class="line">    \</span><br><span class="line">    --idl <span class="variable">$djinni_file</span></span><br></pre></td></tr></table></figure>
<p>其读取了<code>local.properties</code>内配置的 Djinni 目录路径。</p>
<figure class="highlight bash"><figcaption><span>local.properties</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/local.properties" target="_blank" rel="external">local.properties</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">djinni.dir=&lt;path-to-djinni&gt;</span><br><span class="line">gyp.dir=&lt;path-to-gyp&gt;</span><br><span class="line">ndk.dir=&lt;path-to-ndk&gt;</span><br></pre></td></tr></table></figure>
<p>运行后，代码生成在了<code>generated-src</code>目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./run_djinni.sh</span><br></pre></td></tr></table></figure>
<h4 id="实现-C-接口"><a href="#实现-C-接口" class="headerlink" title="实现 C++ 接口"></a>实现 C++ 接口</h4><p>首先，创建<code>src</code>目录，存放手写的代码。然后，于子目录<code>cpp</code>内实现 C++ 接口。</p>
<figure class="highlight hpp"><figcaption><span>src/cpp/hello_djinni_impl.hpp</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/src/cpp/hello_djinni_impl.hpp" target="_blank" rel="external">hello_djinni_impl.hpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"hello_djinni.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> hellodjinni &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> HelloDjinniImpl : <span class="keyword">public</span> HelloDjinni &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Constructor</span></span><br><span class="line">    HelloDjinniImpl();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Our method that returns a string</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">get_hello_djinni</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace hellodjinni</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><figcaption><span>src/cpp/hello_djinni_impl.cpp</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/src/cpp/hello_djinni_impl.cpp" target="_blank" rel="external">hello_djinni_impl.cpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"hello_djinni_impl.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> hellodjinni;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;HelloDjinni&gt; HelloDjinni::create() &#123;</span><br><span class="line">    return <span class="built_in">std</span>::make_shared&lt;HelloDjinniImpl&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HelloDjinniImpl::HelloDjinniImpl() &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> HelloDjinniImpl::get_hello_djinni() &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> result = <span class="string">"Hello Djinni! "</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">time_t</span> t = time(<span class="number">0</span>);</span><br><span class="line">    tm now = *localtime(&amp;t);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> tm_desc[<span class="number">200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (strftime(tm_desc, sizeof(tm_desc)<span class="number">-1</span>, <span class="string">"%r"</span>, &amp;now)&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        result += tm_desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="C-工程"><a href="#C-工程" class="headerlink" title="C++ 工程"></a>C++ 工程</h3><p>这里用 XCode 创建一个 C++ 工程，来测试 C++ 接口代码。</p>
<p>首先，打开 XCode ，选择”Create a new Xcode project”。然后，选择”Command Line Tool”，来新建命令行工具。</p>
<img src="/2016/05/06/using-djinni/cpp_pro_new.png" alt="cpp_pro_new.png" title="">
<p>“Next”到下一步时，”Language”选择”C++”。</p>
<img src="/2016/05/06/using-djinni/cpp_pro_new_2.png" alt="cpp_pro_new_2.png" title="">
<p>工程最后保存到了<code>project/cpp</code>目录。整个文件结构如下：</p>
<img src="/2016/05/06/using-djinni/cpp_pro_structure.png" width="240">
<p>接下来，把以下 C++ 接口代码文件，拖动到 XCode 工程目录来引入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">generated-src/cpp/hello_djinni.hpp</span><br><span class="line">src/cpp/hello_djinni_impl.cpp</span><br><span class="line">src/cpp/hello_djinni_impl.hpp</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：取消”Copy items if needed”，选择”Create folder references”。只需引用文件，避免复制。</p>
</blockquote>
<img src="/2016/05/06/using-djinni/cpp_pro_move.png" alt="cpp_pro_move.png" title="">
<p>然后，编写好<code>main.cpp</code>的代码：</p>
<figure class="highlight cpp"><figcaption><span>project/cpp/HelloDjinni/HelloDjinni/main.cpp</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/cpp/HelloDjinni/HelloDjinni/main.cpp" target="_blank" rel="external">main.cpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"hello_djinni_impl.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typedef</span> hellodjinni::HelloDjinni HelloDjinni;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> hd = HelloDjinni::create();</span><br><span class="line">    <span class="keyword">auto</span> result = hd-&gt;get_hello_djinni();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; result &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，运行项目，结果如下：</p>
<img src="/2016/05/06/using-djinni/cpp_pro_overview.png" alt="cpp_pro_overview.png" title="">
<p>或者，写个<code>project/Cpp.mk</code>：</p>
<figure class="highlight makefile"><figcaption><span>project/Cpp.mk</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/Cpp.mk" target="_blank" rel="external">Cpp.mk</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">MD := -mkdir -p</span><br><span class="line">RD := -rm -rf</span><br><span class="line">RM := -rm -f</span><br><span class="line"></span><br><span class="line">CC := gcc</span><br><span class="line">CXX := g++</span><br><span class="line">CXXFLAGS := -std=c++11 -Wall</span><br><span class="line"></span><br><span class="line">ifdef DEBUG</span><br><span class="line">CXXFLAGS += -g -DDEBUG</span><br><span class="line">else</span><br><span class="line">CXXFLAGS += -O2 -DNDEBUG</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">OUT_DIR ?= build</span><br><span class="line">CPP_OUT ?= <span class="variable">$(OUT_DIR)</span>/cpp</span><br><span class="line"></span><br><span class="line">CPP_INCLUDES := \</span><br><span class="line">    ../generated-src/cpp \</span><br><span class="line">    ../src/cpp</span><br><span class="line">CPP_SOURCES := \</span><br><span class="line">    ../src/cpp/hello_djinni_impl.cpp \</span><br><span class="line">    cpp/HelloDjinni/HelloDjinni/main.cpp</span><br><span class="line">CPP_TARGET := <span class="variable">$(CPP_OUT)</span>/HelloDjinni</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">all: cpp_pro</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    $(RD) $(CPP_OUT)/</span><br><span class="line"></span><br><span class="line">cpp_pro: $(CPP_SOURCES)</span><br><span class="line">    @echo "\033[1;35;47mBuild cpp project...\033[0m"</span><br><span class="line">    @$(MD) $(CPP_OUT)</span><br><span class="line">    $(CXX) $(CXXFLAGS) $(CPP_SOURCES) -o $(CPP_TARGET) \</span><br><span class="line">        $(foreach d, $(CPP_INCLUDES), -I$d)</span><br><span class="line">    @echo "\033[32mOutput:\033[0m\n$(CPP_TARGET)"</span><br><span class="line">    @echo "\033[32mRunning:\033[0m"</span><br><span class="line">    @$(CPP_TARGET)</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: cpp_pro clean all</span></span><br></pre></td></tr></table></figure>
<p>然后，<code>make -f Cpp.mk</code>编译运行，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Build cpp project...</span><br><span class="line">g++ -std=c++11 -Wall -O2 -DNDEBUG \</span><br><span class="line">    ../src/cpp/hello_djinni_impl.cpp \</span><br><span class="line">    cpp/HelloDjinni/HelloDjinni/main.cpp \</span><br><span class="line">    -o build/cpp/HelloDjinni \</span><br><span class="line">    -I../generated-src/cpp -I../src/cpp</span><br><span class="line">Output:</span><br><span class="line">build/cpp/HelloDjinni</span><br><span class="line">Running:</span><br><span class="line">Hello Djinni! 11:46:56 PM</span><br></pre></td></tr></table></figure>
<h3 id="iOS-工程"><a href="#iOS-工程" class="headerlink" title="iOS 工程"></a>iOS 工程</h3><p>打开 XCode，”File &gt; New &gt; Workspace”新建一个工作区，保存到<code>project/ios</code>目录。</p>
<p>接着，”File &gt; New &gt; Project”，选择”Single View Application”，创建 iOS 工程。</p>
<img src="/2016/05/06/using-djinni/ios_pro_new.png" alt="ios_pro_new.png" title="">
<p>“Next”到下一步时，”Language”选择”Objective-C”。</p>
<img src="/2016/05/06/using-djinni/ios_pro_new_2.png" alt="ios_pro_new_2.png" title="">
<p>工程保存到<code>project/ios</code>目录，”Add to”选择刚才的工作区。</p>
<img src="/2016/05/06/using-djinni/ios_pro_new_3.png" alt="ios_pro_new_3.png" title="">
<p>“Create”完成创建。</p>
<h4 id="生成接口-Libraries-工程"><a href="#生成接口-Libraries-工程" class="headerlink" title="生成接口 Libraries 工程"></a>生成接口 Libraries 工程</h4><p>利用 Djinni, GYP 及 Make 生成接口 Libraries 工程。</p>
<p>首先，创建 GYP 文件：</p>
<figure class="highlight json"><figcaption><span>project/libhellodjinni.gyp</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/libhellodjinni.gyp" target="_blank" rel="external">libhellodjinni.gyp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"targets"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"target_name"</span>: <span class="string">"libhellodjinni_jni"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"shared_library"</span>,</span><br><span class="line">      <span class="attr">"dependencies"</span>: [</span><br><span class="line">        <span class="string">"&lt;(DJINNI_DIR)/support-lib/support_lib.gyp:djinni_jni"</span>,</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"ldflags"</span>: [ <span class="string">"-llog"</span>, <span class="string">"-Wl,--build-id,--gc-sections,--exclude-libs,ALL"</span> ],</span><br><span class="line">      <span class="attr">"sources"</span>: [</span><br><span class="line">        <span class="string">"&lt;(DJINNI_DIR)/support-lib/jni/djinni_main.cpp"</span>,</span><br><span class="line">        <span class="string">"&lt;!@(python &lt;(DJINNI_DIR)/example/glob.py ../generated-src/jni '*.cpp')"</span>,</span><br><span class="line">        <span class="string">"&lt;!@(python &lt;(DJINNI_DIR)/example/glob.py ../generated-src/cpp '*.cpp')"</span>,</span><br><span class="line">        <span class="string">"&lt;!@(python &lt;(DJINNI_DIR)/example/glob.py ../src '*.cpp')"</span>,</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"include_dirs"</span>: [</span><br><span class="line">        <span class="string">"../generated-src/jni"</span>,</span><br><span class="line">        <span class="string">"../generated-src/cpp"</span>,</span><br><span class="line">        <span class="string">"../src/cpp"</span>,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"target_name"</span>: <span class="string">"libhellodjinni_objc"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"static_library"</span>,</span><br><span class="line">      <span class="attr">"dependencies"</span>: [</span><br><span class="line">        <span class="string">"&lt;(DJINNI_DIR)/support-lib/support_lib.gyp:djinni_objc"</span>,</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"sources"</span>: [</span><br><span class="line">        <span class="string">"&lt;!@(python &lt;(DJINNI_DIR)/example/glob.py ../generated-src/objc '*.cpp' '*.mm' '*.m')"</span>,</span><br><span class="line">        <span class="string">"&lt;!@(python &lt;(DJINNI_DIR)/example/glob.py ../generated-src/cpp  '*.cpp')"</span>,</span><br><span class="line">        <span class="string">"&lt;!@(python &lt;(DJINNI_DIR)/example/glob.py ../src '*.cpp')"</span>,</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"include_dirs"</span>: [</span><br><span class="line">        <span class="string">"../generated-src/objc"</span>,</span><br><span class="line">        <span class="string">"../generated-src/cpp"</span>,</span><br><span class="line">        <span class="string">"../src/cpp"</span>,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：<br>1) <code>sources</code>内的路径必须是相对路径。虽然会识别以<code>/</code>开头的字符串为绝对路径，但在 XCode 工程内其路径引用是不正确的。<br>2) GYP 生成 Android Makefile 时，运行命令时的工作目录，必须能够直接子目录到所有代码，包括依赖的 Djinni 的 support-lib 。不然，会报如下错误：</p>
<blockquote>
<p>AssertionError: Path %s attempts to escape from gyp path %s !)</p>
</blockquote>
<p>👌的话，<code>GypAndroid.mk</code>会生成到当前工作目录。GYP 生成 Android 时，不允许指定<code>--generator-output</code>：</p>
<blockquote>
<p>AssertionError: The Android backend does not support options.generator_output.</p>
</blockquote>
</blockquote>
<p>所以，简单的解决办法是，文件结构与<code>[djinni_root]/example</code>一致，并<code>git submodule</code> Djinni 与 GYP 到工程目录内。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git init</span><br><span class="line">$ git submodule add https://github.com/dropbox/djinni.git deps/djinni</span><br><span class="line">$ git submodule add https://chromium.googlesource.com/external/gyp.git deps/gyp</span><br></pre></td></tr></table></figure>
<p>如果仍想要 Djinni 与 GYP 独立于工程目录外，同时又能够工作在工程目录，那么需要把依赖的东西复制进工程目录。之后，即是这样做的。</p>
<p>接下来，创建 Makefile 文件：</p>
<figure class="highlight makefile"><figcaption><span>project/Makefile</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/Makefile" target="_blank" rel="external">Makefile</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">MD := -mkdir -p</span><br><span class="line">RD := -rm -rf</span><br><span class="line">RM := -rm -f</span><br><span class="line"></span><br><span class="line">SED_PROP := "s/&lt;[^&gt;]*&gt;//g;s/.*=\(.*\)/\1/"</span><br><span class="line"></span><br><span class="line">define read_prop</span><br><span class="line">    $(eval $(1) := $(shell ../tools/read_properties.sh \</span><br><span class="line">        | grep -m1 $(2) | sed $(SED_PROP)))</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">$(call read_prop,GYP_DIR,gyp_dir)</span><br><span class="line">$(call read_prop,NDK_DIR,ndk_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OUT_DIR ?= build</span><br><span class="line">IOS_OUT ?= <span class="variable">$(OUT_DIR)</span>/ios</span><br><span class="line"></span><br><span class="line">DEPS_DIR ?= deps</span><br><span class="line">DEPS_DJINNI_DIR := <span class="variable">$(DEPS_DIR)</span>/djinni</span><br><span class="line"></span><br><span class="line">DJINNI_OUT_DIR ?= ../generated-src</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: all</span></span><br><span class="line">all: cpp_pro ios_pro android_pro android_pro2</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    @make ios_pro_clean</span><br><span class="line">    @make android_pro_clean</span><br><span class="line">    @make android_pro2_clean</span><br><span class="line">    @echo "\033[1;35;47mClean others...\033[0m"</span><br><span class="line">    $(RD) $(OUT_DIR)/</span><br><span class="line">    $(RD) $(DEPS_DIR)/</span><br><span class="line">    $(RD) $(DJINNI_OUT_DIR)/</span><br><span class="line">    $(RM) ../GypAndroid.mk</span><br><span class="line">    $(RM) libhellodjinni_jni.target.mk</span><br><span class="line">    @<span class="comment"># @make cpp_pro_clean</span></span><br><span class="line"></span><br><span class="line"><span class="section">deps:</span></span><br><span class="line">    @echo "\033[1;35;47mPrepare dependencies...\033[0m"</span><br><span class="line">    @../tools/prepare_deps.sh $(DEPS_DIR)</span><br><span class="line"></span><br><span class="line">$(DJINNI_OUT_DIR): ../hellodjinni.djinni</span><br><span class="line">    @echo "\033[1;35;47mGenerate djinni interface code...\033[0m"</span><br><span class="line">    @../run_djinni.sh</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: djinni</span></span><br><span class="line">djinni: $(DJINNI_OUT_DIR)</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: cpp_pro</span></span><br><span class="line">cpp_pro: $(DJINNI_OUT_DIR)</span><br><span class="line">    @make -f Cpp.mk cpp_pro</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: cpp_pro_clean</span></span><br><span class="line"><span class="section">cpp_pro_clean:</span></span><br><span class="line">    @make -f Cpp.mk clean</span><br><span class="line"></span><br><span class="line">$(IOS_OUT)/libhellodjinni.xcodeproj: deps $(DJINNI_OUT_DIR) libhellodjinni.gyp \</span><br><span class="line">        $(DEPS_DJINNI_DIR)/support-lib/support_lib.gyp</span><br><span class="line">    @echo "\033[1;35;47mGenerate libhellodjinni.xcodeproj...\033[0m"</span><br><span class="line">    @$(GYP_DIR)/gyp --depth=. -f xcode -DOS=ios \</span><br><span class="line">        --generator-output $(IOS_OUT) \</span><br><span class="line">        -DDJINNI_DIR=$(DEPS_DJINNI_DIR) \</span><br><span class="line">        -I$(DEPS_DJINNI_DIR)/common.gypi \</span><br><span class="line">        libhellodjinni.gyp</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: ios_pro</span></span><br><span class="line">ios_pro: $(IOS_OUT)/libhellodjinni.xcodeproj</span><br><span class="line">    @echo "\033[1;35;47mBuild ios project...\033[0m"</span><br><span class="line">    xcodebuild -workspace ios/HelloDjinni.xcworkspace \</span><br><span class="line">        -scheme HelloDjinni -configuration 'Debug' -sdk iphonesimulator</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: ios_pro_clean</span></span><br><span class="line"><span class="section">ios_pro_clean:</span></span><br><span class="line">    @echo "\033[1;35;47mClean ios project...\033[0m"</span><br><span class="line">    @-xcodebuild -workspace ios/HelloDjinni.xcworkspace \</span><br><span class="line">        -scheme HelloDjinni -configuration 'Debug' -sdk iphonesimulator clean</span><br><span class="line"></span><br><span class="line">../GypAndroid.mk: deps $(DJINNI_OUT_DIR) libhellodjinni.gyp \</span><br><span class="line">        $(DEPS_DJINNI_DIR)/support-lib/support_lib.gyp</span><br><span class="line">    @echo "\033[1;35;47mGenerate GypAndroid.mk...\033[0m"</span><br><span class="line">    @make gyp_android</span><br><span class="line">    @cd .. &amp;&amp; ANDROID_BUILD_TOP=$(NDK_DIR) \</span><br><span class="line">        $(GYP_DIR)/gyp --depth=. -f android -DOS=android \</span><br><span class="line">        -DDJINNI_DIR=$(DEPS_DJINNI_DIR) \</span><br><span class="line">        -Iproject/$(DEPS_DJINNI_DIR)/common.gypi \</span><br><span class="line">        project/libhellodjinni.gyp \</span><br><span class="line">        --root-target=libhellodjinni_jni</span><br><span class="line">    @make gyp_master</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: android_pro</span></span><br><span class="line">android_pro: ../GypAndroid.mk</span><br><span class="line">    @echo "\033[1;35;47mBuild android project (HelloDjinni)...\033[0m"</span><br><span class="line">    cd android/HelloDjinni/ &amp;&amp; ./gradlew app:assembleDebug</span><br><span class="line">    @echo "\033[32mApks produced at:\033[0m"</span><br><span class="line">    @python $(DEPS_DJINNI_DIR)/example/glob.py \</span><br><span class="line">        android/HelloDjinni/app/build/outputs/apk/ '*.apk'</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: android_pro_clean</span></span><br><span class="line">android_pro_clean: ../GypAndroid.mk</span><br><span class="line">    @echo "\033[1;35;47mClean android project (HelloDjinni)...\033[0m"</span><br><span class="line">    @ndk-build -C android/HelloDjinni/app-core clean</span><br><span class="line">    @-cd android/HelloDjinni/ &amp;&amp; ./gradlew clean</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: android_pro2</span></span><br><span class="line">android_pro2: deps djinni libhellodjinni.gyp \</span><br><span class="line">        $(DEPS_DJINNI_DIR)/support-lib/support_lib.gyp</span><br><span class="line">    @echo "\033[1;35;47mBuild android project (HelloDjinni2)...\033[0m"</span><br><span class="line">    cd android/HelloDjinni2/ &amp;&amp; ./gradlew app:assembleDebug</span><br><span class="line">    @echo "\033[32mApks produced at:\033[0m"</span><br><span class="line">    @python $(DEPS_DJINNI_DIR)/example/glob.py \</span><br><span class="line">        android/HelloDjinni2/app/build/outputs/apk/ '*.apk'</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: android_pro2_clean</span></span><br><span class="line"><span class="section">android_pro2_clean:</span></span><br><span class="line">    @echo "\033[1;35;47mClean android project (HelloDjinni2)...\033[0m"</span><br><span class="line">    @-cd android/HelloDjinni2/ &amp;&amp; ./gradlew clean</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gyp_status</span></span><br><span class="line"><span class="section">gyp_status:</span></span><br><span class="line">    @cd $(GYP_DIR) &amp;&amp; git status</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gyp_master</span></span><br><span class="line"><span class="section">gyp_master:</span></span><br><span class="line">    @echo "\033[1;35;47mCheckout gyp to master...\033[0m"</span><br><span class="line">    @cd $(GYP_DIR) &amp;&amp; git checkout master</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gyp_android</span></span><br><span class="line"><span class="section">gyp_android:</span></span><br><span class="line">    @echo "\033[1;35;47mCheckout gyp to android generator...\033[0m"</span><br><span class="line">    @cd $(GYP_DIR) &amp;&amp; git checkout -q 0bb67471bca068996e15b56738fa4824dfa19de0</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: test_vars</span></span><br><span class="line"><span class="section">test_vars:</span></span><br><span class="line">    @echo "\033[1;35;47mPrint variables...\033[0m"</span><br><span class="line">    @echo GYP_DIR=$(GYP_DIR)</span><br><span class="line">    @echo NDK_DIR=$(NDK_DIR)</span><br><span class="line">    @echo OUT_DIR=$(OUT_DIR)</span><br><span class="line">    @echo IOS_OUT=$(IOS_OUT)</span><br><span class="line">    @echo DEPS_DIR=$(DEPS_DIR)</span><br><span class="line">    @echo DEPS_DJINNI_DIR=$(DEPS_DJINNI_DIR)</span><br></pre></td></tr></table></figure>
<p>其也包括了 Android 工程的配置。</p>
<blockquote>
<p>注：额外依赖了两个辅助脚本，说明如下：<br><code>read_properties.sh</code>，读取<code>local.properties</code>内配置的路径。<br><code>prepare_deps.sh</code>，准备依赖的文件到指定目录。</p>
</blockquote>
<p>然后，运行生成 XCode 的 libhellodjinni 工程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> project/</span><br><span class="line">$ make ios_pro</span><br></pre></td></tr></table></figure>
<p>其生成在<code>project/build/ios</code>目录。 XCode 直接打开<code>libhellodjinni.xcodeproj</code>，即可选择目标进行编译。</p>
<p>但可能此时 libhellodjinni_jni 与 djinni_jni (support_lib) 目标，不能够找到<code>jni.h</code>。由于 ios 上不需要 jni 绑定，后续也不需依赖，没多大影响。</p>
<p>也让其可通过编译的话，只需要选择目标，在”Build Settings &gt; Header Search Paths”内，添加 Java VM include 就好。</p>
<p>运行如下命令，获得当前的 Java 头文件路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls <span class="_">-l</span> `<span class="built_in">which</span> java` | sed <span class="string">'s/^.*-&gt; *\(.*Current\).*$/\1\/Headers/;q'</span></span><br></pre></td></tr></table></figure>
<p>结果，如：”/System/Library/Frameworks/JavaVM.framework/Versions/Current/Headers”。</p>
<p>或者，这里找：”/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/include/“。</p>
<img src="/2016/05/06/using-djinni/ios_pro_lib_header.png" alt="ios_pro_lib_header.png" title="">
<h4 id="添加接口-Libraries-依赖"><a href="#添加接口-Libraries-依赖" class="headerlink" title="添加接口 Libraries 依赖"></a>添加接口 Libraries 依赖</h4><p>现在，给 iOS 工程上添加上接口 Libraries 的依赖。</p>
<p>首先，打开先前的工作区<code>project/ios/HelloDjinni.xcworkspace</code>。于左侧项目导航的灰色区域，”Ctrl+Click”或右击打开菜单。选择”Add Files to “HelloDjinni””，添加生成好的<code>libhellodjinni.xcodeproj</code>和<code>support_lib.xcodeproj</code>两个库工程。</p>
<p>之后，项目导航选中”HelloDjinni”工程，并选择”HelloDjinni”目标。在”Build Phases”标签页的”Link Binaries With Libraries”选项下，新增 libhellodjinni_objc.a 与 libdjinni_objc.a 的依赖，如下：</p>
<img src="/2016/05/06/using-djinni/ios_pro_lib_link.png" alt="ios_pro_lib_link.png" title="">
<p>在”Build Settings”标签页，找到”Header Search Paths”，添加头文件搜索路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$(SRCROOT)/../../deps/djinni/support-lib/objc</span><br><span class="line">$(SRCROOT)/../../../generated-src/objc</span><br></pre></td></tr></table></figure>
<p>为了兼容 Objective-C++ 桥接代码，需要将<code>HelloWorld/Supporting Files/main.m</code>重命名为<code>main.mm</code>。</p>
<p>最终，工作区会类似于下面这样：</p>
<img src="/2016/05/06/using-djinni/ios_pro_overview.png" alt="ios_pro_overview.png" title="">
<h4 id="完成-UI-并运行"><a href="#完成-UI-并运行" class="headerlink" title="完成 UI 并运行"></a>完成 UI 并运行</h4><p>于<code>ViewController.m</code>内编写代码，创建 UI 并调用接口代码。</p>
<figure class="highlight objc"><figcaption><span>project/ios/HelloDjinni/HelloDjinni/ViewController.m</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/ios/HelloDjinni/HelloDjinni/ViewController.m" target="_blank" rel="external">ViewController.m</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"HDHelloDjinni.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span> </span>&#123;</span><br><span class="line">    HDHelloDjinni *_helloDjinniInterface;</span><br><span class="line">    <span class="built_in">UIButton</span> *_button;</span><br><span class="line">    <span class="built_in">UITextView</span> *_textView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// instantiate our library interface</span></span><br><span class="line">    _helloDjinniInterface = [HDHelloDjinni create];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a button programatically for the demo</span></span><br><span class="line">    _button = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeRoundedRect</span>];</span><br><span class="line">    [_button addTarget:<span class="keyword">self</span></span><br><span class="line">                action:<span class="keyword">@selector</span>(buttonWasPressed:)</span><br><span class="line">      forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    [_button setTitle:<span class="string">@"Get Hello Djinni!"</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    _button.frame = <span class="built_in">CGRectMake</span>(<span class="number">20.0</span>, <span class="number">20.0</span>, <span class="number">280.0</span>, <span class="number">40.0</span>);</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:_button];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a text view programatically</span></span><br><span class="line">    _textView = [[<span class="built_in">UITextView</span> alloc] init];</span><br><span class="line">    <span class="comment">// x, y, width, height</span></span><br><span class="line">    _textView.frame = <span class="built_in">CGRectMake</span>(<span class="number">20.0</span>, <span class="number">80.0</span>, <span class="number">280.0</span>, <span class="number">380.0</span>);</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:_textView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buttonWasPressed:(<span class="built_in">UIButton</span> *)sender &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *response = [_helloDjinniInterface getHelloDjinni];</span><br><span class="line">    _textView.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@\n%@"</span>, response, _textView.text];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)didReceiveMemoryWarning &#123;</span><br><span class="line">    [<span class="keyword">super</span> didReceiveMemoryWarning];</span><br><span class="line">    <span class="comment">// Dispose of any resources that can be recreated.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>“Product &gt; Run”运行项目。 UI 上”Get Hello Djinni!”的按钮，每点击下就会添加条从 C++ 返回的信息。</p>
<img src="/2016/05/06/using-djinni/ios_pro_result.png" width="300">
<h3 id="Android-工程"><a href="#Android-工程" class="headerlink" title="Android 工程"></a>Android 工程</h3><p>Android 工程介绍了两种方式，来整合 NDK Library ：</p>
<ul>
<li>一是，使用 GYP 生成的 Android Makefile ， Gradle 配置 ndk-build 进行编译。</li>
<li>二是，使用 Experimental Plugin ，直接配置成支持 NDK 的工程。</li>
</ul>
<h4 id="使用-GypMakefile"><a href="#使用-GypMakefile" class="headerlink" title="使用 GypMakefile"></a>使用 GypMakefile</h4><p>GYP 生成 Android Makefile ，使用之前写好的<code>project/Makefile</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> project/</span><br><span class="line">$ make android_pro</span><br></pre></td></tr></table></figure>
<p><code>GypAndroid.mk</code>会生成到父级<code>hellodjinni</code>目录。</p>
<p>如果还没准备好 Studio 工程，不会继续生成 APK ，会报“找不到<code>android/HelloDjinni/</code>”。</p>
<p>现在，打开 Android Studio，选择”Start a new Android Studio Project”。</p>
<p>“New”页，”Project Location”存到<code>project/android/HelloDjinni</code>，如下：</p>
<img src="/2016/05/06/using-djinni/android_pro_new.png" alt="android_pro_new.png" title="">
<p>之后，”Target”页选”Phone and Tablet”，”Add”页选”Empty Activity”，最终完成新建。</p>
<p>于”File &gt; Project Structure &gt; SDK Location &gt; Android NDK Location”，设置 NDK 路径：</p>
<img src="/2016/05/06/using-djinni/android_pro_sdk.png" alt="android_pro_sdk.png" title="">
<p>接下来，独立建一个 app-core Library 模块来引用 C++ 代码。”File &gt; New Module”，选”Android Library”：</p>
<img src="/2016/05/06/using-djinni/android_pro_new_lib.png" alt="android_pro_new_lib.png" title="">
<p>然后，修改此 app-core 的<code>build.gradle</code>，添加引用及 NDK 编译。变更如下：</p>
<figure class="highlight gradle"><figcaption><span>project/android/HelloDjinni/app-core/build.gradle</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni/app-core/build.gradle" target="_blank" rel="external">build.gradle</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.library'</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">sourceSets</span> &#123;</span><br><span class="line">        main &#123;</span><br><span class="line">            java.srcDirs += [<span class="string">'../../../../generated-src/java'</span>]</span><br><span class="line">            jni.srcDirs = []</span><br><span class="line">            jniLibs.srcDirs = [<span class="string">'libs'</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//compile 'com.android.support:appcompat-v7:23.3.0'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">task</span> ndkBuild(type: Exec) &#123;</span><br><span class="line">    <span class="keyword">def</span> moduleDir = System.getProperty(<span class="string">"user.dir"</span>) + <span class="string">"/app-core/"</span></span><br><span class="line">    <span class="keyword">def</span> ndkDir = plugins.getPlugin(<span class="string">'com.android.library'</span>).sdkHandler.ndkFolder</span><br><span class="line">    <span class="keyword">if</span> (ndkDir == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">def</span> gradle_project_root = <span class="keyword">project</span>.rootProject.rootDir</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GradleException(<span class="string">"NDK is not configured. Make sure there is a local.properties "</span> +</span><br><span class="line">                <span class="string">"file with an ndk.dir entry in the directory $&#123;gradle_project_root&#125;."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">def</span> ndkBuildExecutable = <span class="keyword">new</span> <span class="keyword">File</span>(ndkDir, <span class="string">'ndk-build'</span>)</span><br><span class="line">    <span class="keyword">if</span> (!ndkBuildExecutable.exists()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GradleException(<span class="string">"Could not find ndk-build. The configured NDK directory $&#123;ndkDir&#125; may not be correct."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    environment(<span class="string">"NDK_PROJECT_PATH"</span>, moduleDir)</span><br><span class="line">    environment(<span class="string">"GYP_CONFIGURATION"</span>, <span class="string">"Release"</span>)</span><br><span class="line">    commandLine ndkBuildExecutable</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    compileTask -&gt; compileTask.dependsOn ndkBuild</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>项目导航栏切到 Project 视图，在 app-core 下新建<code>jni</code>目录，创建 NDK 的工程文件。</p>
<figure class="highlight makefile"><figcaption><span>project/android/HelloDjinni/app-core/jni/Android.mk</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni/app-core/jni/Android.mk" target="_blank" rel="external">Android.mk</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># always force this build to re-run its dependencies</span></span><br><span class="line">FORCE_GYP := <span class="variable">$(shell make -C ../../../../ GypAndroid.mk)</span></span><br><span class="line">include ../../../../GypAndroid.mk</span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><figcaption><span>project/android/HelloDjinni/app-core/jni/Application.mk</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni/app-core/jni/Application.mk" target="_blank" rel="external">Application.mk</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Android makefile for libhellodjinni shared lib</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Application.mk: http://developer.android.com/ndk/guides/application_mk.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># APP_ABI := all</span></span><br><span class="line"><span class="comment"># skipping mips / mips64</span></span><br><span class="line">APP_ABI := armeabi armeabi-v7a arm64-v8a x86 x86_64</span><br><span class="line">APP_OPTIM := release</span><br><span class="line">APP_PLATFORM := android-14</span><br><span class="line"><span class="comment"># GCC 4.9 Toolchain - requires NDK r10</span></span><br><span class="line">NDK_TOOLCHAIN_VERSION = 4.9</span><br><span class="line"><span class="comment"># GNU libc++ is the only Android STL which supports C++11 features</span></span><br><span class="line">APP_CFLAGS += -Wall</span><br><span class="line">APP_CPPFLAGS += -std=c++11 -frtti -fexceptions</span><br><span class="line">APP_STL := gnustl_static</span><br><span class="line">APP_BUILD_SCRIPT := jni/Android.mk</span><br><span class="line">APP_MODULES := libhellodjinni_jni</span><br></pre></td></tr></table></figure>
<p>这样，独立的 app-core Library 就👌了。</p>
<p>回到 app ，修改其<code>build.gradle</code>，以依赖 app-core 。变更如下：</p>
<figure class="highlight gradle"><figcaption><span>project/android/HelloDjinni/app/build.gradle</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni/app/build.gradle" target="_blank" rel="external">build.gradle</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':app-core'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建<code>MyApplication.java</code>，作为自定义 Application。并设置到<code>AndroidManifest.xml</code>内”application”的”name”字段。</p>
<figure class="highlight java"><figcaption><span>project/android/HelloDjinni/app/src/.../MyApplication.java</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni/app/src/main/java/cc/eevee/hellodjinni/MyApplication.java" target="_blank" rel="external">MyApplication.java</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.eevee.hellodjinni;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.loadLibrary(<span class="string">"hellodjinni_jni"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsatisfiedLinkError e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Native code library failed to load.\n"</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终，项目导航 Android 和 Project 视图类似下面这样：</p>
<img src="/2016/05/06/using-djinni/android_pro_nav.png" alt="android_pro_nav.png" title="">
<p>接着，修改 app UI，<code>MainActivity.java</code>及其布局<code>activity_main.xml</code>：</p>
<figure class="highlight java"><figcaption><span>project/android/HelloDjinni/app/src/.../MainActivity.java</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni/app/src/main/java/cc/eevee/hellodjinni/MainActivity.java" target="_blank" rel="external">MainActivity.java</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.eevee.hellodjinni;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ScrollView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TextView mTextView;</span><br><span class="line">    <span class="keyword">private</span> ScrollView mScrollView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HelloDjinni mHelloDjinniInterface = HelloDjinni.create();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mTextView = (TextView) findViewById(R.id.textView);</span><br><span class="line">        mScrollView = (ScrollView) findViewById(R.id.scrollView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onButtonClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        mTextView.append(mHelloDjinniInterface.getHelloDjinni() + <span class="string">"\n"</span>);</span><br><span class="line">        mScrollView.fullScroll(ScrollView.FOCUS_DOWN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><figcaption><span>project/android/HelloDjinni/app/src/.../activity_main.xml</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni/app/src/main/res/layout/activity_main.xml" target="_blank" rel="external">activity_main.xml</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span><br><span class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span><br><span class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span><br><span class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span><br><span class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span><br><span class="line">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span><br><span class="line">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span><br><span class="line">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span><br><span class="line">    <span class="attr">tools:context</span>=<span class="string">"cc.eevee.hellodjinni.MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span><br><span class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></span><br><span class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span><br><span class="line">        <span class="attr">android:text</span>=<span class="string">"Get Hello Djinni!"</span></span><br><span class="line">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span><br><span class="line">        <span class="attr">android:onClick</span>=<span class="string">"onButtonClick"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span></span><br><span class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/scrollView"</span></span><br><span class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span><br><span class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span></span><br><span class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>“Run &gt; Run ‘app’”运行项目。 UI 上”Get Hello Djinni!”的按钮，每点击下就会添加条从 C++ 返回的信息。</p>
<img src="/2016/05/06/using-djinni/android_pro_result.png" width="300">
<h4 id="使用新试验性插件"><a href="#使用新试验性插件" class="headerlink" title="使用新试验性插件"></a>使用新试验性插件</h4><p>Android Studio 1.3 版本开始支持 NDK，需要使用 Experimental Plugin 。这里为当前最新的 0.7.0 版本。</p>
<p>同样，打开 Android Studio，选择”Start a new Android Studio Project”，新建一个”HelloDjinni2”工程。</p>
<img src="/2016/05/06/using-djinni/android_pro2_new.png" alt="android_pro2_new.png" title="">
<p>之后，”Target”页选”Phone and Tablet”，”Add”页选”Empty Activity”，最终完成新建。</p>
<p>于”File &gt; Project Structure &gt; SDK Location &gt; Android NDK Location”，设置 NDK 路径。</p>
<p>接下来，修改成 Experimental Plugin 。先是工程配置：</p>
<figure class="highlight gradle"><figcaption><span>project/android/HelloDjinni2/build.gradle</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni2/build.gradle" target="_blank" rel="external">build.gradle</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle-experimental:0.7.0'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">task</span> clean(type: <span class="keyword">Delete</span>) &#123;</span><br><span class="line">    <span class="keyword">delete</span> rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着是 app 模块配置：</p>
<figure class="highlight gradle"><figcaption><span>project/android/HelloDjinni2/app/build.gradle</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni2/app/build.gradle" target="_blank" rel="external">build.gradle</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.model.application'</span></span><br><span class="line"></span><br><span class="line">model &#123;</span><br><span class="line">    android &#123;</span><br><span class="line">        compileSdkVersion = <span class="number">23</span></span><br><span class="line">        buildToolsVersion = <span class="string">'23.0.3'</span></span><br><span class="line"></span><br><span class="line">        defaultConfig &#123;</span><br><span class="line">            applicationId = <span class="string">'cc.eevee.hellodjinni2'</span></span><br><span class="line">            minSdkVersion.apiLevel    = <span class="number">14</span></span><br><span class="line">            targetSdkVersion.apiLevel = <span class="number">23</span></span><br><span class="line">            versionCode = <span class="number">1</span></span><br><span class="line">            versionName = <span class="string">'1.0'</span></span><br><span class="line">        &#125;</span><br><span class="line">        buildTypes &#123;</span><br><span class="line">            release &#123;</span><br><span class="line">                minifyEnabled = <span class="keyword">false</span></span><br><span class="line">                proguardFiles.add(<span class="keyword">file</span>(<span class="string">'proguard-rules.pro'</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:23.3.0'</span></span><br><span class="line">    <span class="comment">//compile project(':app-core')</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样， Experimental Plugin 就修改完成了。</p>
<p>接下来，仍旧独立建一个 app-core Library 模块来引用 C++ 代码。”File &gt; New Module”，选”Android Library”：</p>
<img src="/2016/05/06/using-djinni/android_pro2_new_lib.png" alt="android_pro2_new_lib.png" title="">
<p>然后，修改此 app-core 的<code>build.gradle</code>，支持 Experimental Plugin 并配置 NDK 。如下：</p>
<figure class="highlight gradle"><figcaption><span>project/android/HelloDjinni2/app-core/build.gradle</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni2/app-core/build.gradle" target="_blank" rel="external">build.gradle</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.model.library'</span></span><br><span class="line"></span><br><span class="line">model &#123;</span><br><span class="line">    android &#123;</span><br><span class="line">        compileSdkVersion = <span class="number">23</span></span><br><span class="line">        buildToolsVersion = <span class="string">'23.0.3'</span></span><br><span class="line"></span><br><span class="line">        defaultConfig &#123;</span><br><span class="line">            minSdkVersion.apiLevel    = <span class="number">14</span></span><br><span class="line">            targetSdkVersion.apiLevel = <span class="number">23</span></span><br><span class="line">        &#125;</span><br><span class="line">        ndk &#123;</span><br><span class="line">            moduleName = <span class="string">'hellodjinni'</span></span><br><span class="line">            platformVersion = <span class="number">14</span></span><br><span class="line">            toolchain = <span class="string">'gcc'</span></span><br><span class="line">            toolchainVersion = <span class="string">'4.9'</span></span><br><span class="line">            stl = <span class="string">'gnustl_shared'</span></span><br><span class="line">            CFlags.addAll([<span class="string">'-Wall'</span>, <span class="string">'-Werror'</span>])</span><br><span class="line">            cppFlags.addAll([<span class="string">'-std=c++11'</span>, <span class="string">'-fexceptions'</span>, <span class="string">'-frtti'</span>])</span><br><span class="line">            cppFlags.addAll([</span><br><span class="line">                    <span class="string">"-I$&#123;file('../../../deps/djinni/support-lib')&#125;"</span>.toString(),</span><br><span class="line">                    <span class="string">"-I$&#123;file('../../../deps/djinni/support-lib/jni')&#125;"</span>.toString(),</span><br><span class="line">                    <span class="string">"-I$&#123;file('../../../../generated-src/cpp')&#125;"</span>.toString(),</span><br><span class="line">                    <span class="string">"-I$&#123;file('../../../../generated-src/jni')&#125;"</span>.toString(),</span><br><span class="line">            ])</span><br><span class="line">            ldLibs.addAll([<span class="string">'log'</span>])</span><br><span class="line">            abiFilters.addAll([<span class="string">'armeabi'</span>, <span class="string">'armeabi-v7a'</span>, <span class="string">'arm64-v8a'</span>, <span class="string">'x86'</span>, <span class="string">'x86_64'</span>])</span><br><span class="line">        &#125;</span><br><span class="line">        sources &#123;</span><br><span class="line">            <span class="comment">//noinspection GroovyAssignabilityCheck</span></span><br><span class="line">            main &#123;</span><br><span class="line">                jni &#123;</span><br><span class="line">                    <span class="keyword">source</span> &#123;</span><br><span class="line">                        srcDirs += [</span><br><span class="line">                            <span class="string">'../../../deps/djinni/support-lib/jni'</span>,</span><br><span class="line">                            <span class="string">'../../../../generated-src/cpp'</span>,</span><br><span class="line">                            <span class="string">'../../../../generated-src/jni'</span>,</span><br><span class="line">                            <span class="string">'../../../../src/cpp'</span>,</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                java &#123;</span><br><span class="line">                    <span class="keyword">source</span> &#123;</span><br><span class="line">                        srcDirs += [</span><br><span class="line">                            <span class="string">'../../../../generated-src/java'</span>,</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        buildTypes &#123;</span><br><span class="line">            release &#123;</span><br><span class="line">                minifyEnabled = <span class="keyword">false</span></span><br><span class="line">                proguardFiles.add(<span class="keyword">file</span>(<span class="string">'proguard-rules.pro'</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    <span class="comment">//compile 'com.android.support:appcompat-v7:23.3.0'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样之后，可以在 app-core 下看得<code>jni</code>目录，包括了所有 C++ 代码。</p>
<p>回到 app ，修改其<code>build.gradle</code>，以依赖 app-core 。变更如下：</p>
<figure class="highlight gradle"><figcaption><span>project/android/HelloDjinni2/app/build.gradle</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni2/app/build.gradle" target="_blank" rel="external">build.gradle</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':app-core'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建<code>MyApplication.java</code>，作为自定义 Application。并设置到<code>AndroidManifest.xml</code>内”application”的”name”字段。</p>
<figure class="highlight java"><figcaption><span>project/android/HelloDjinni2/app/src/.../MyApplication.java</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni2/app/src/main/java/cc/eevee/hellodjinni2/MyApplication.java" target="_blank" rel="external">MyApplication.java</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.eevee.hellodjinni2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.loadLibrary(<span class="string">"gnustl_shared"</span>);</span><br><span class="line">            System.loadLibrary(<span class="string">"hellodjinni"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsatisfiedLinkError e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Native code library failed to load.\n"</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终，项目导航 Android 和 Project 视图类似下面这样：</p>
<img src="/2016/05/06/using-djinni/android_pro2_nav.png" alt="android_pro2_nav.png" title="">
<p>接着，修改 app UI，<code>MainActivity.java</code>及其布局<code>activity_main.xml</code>：</p>
<figure class="highlight java"><figcaption><span>project/android/HelloDjinni2/app/src/.../MainActivity.java</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni2/app/src/main/java/cc/eevee/hellodjinni2/MainActivity.java" target="_blank" rel="external">MainActivity.java</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.eevee.hellodjinni2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ScrollView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cc.eevee.hellodjinni.HelloDjinni;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TextView mTextView;</span><br><span class="line">    <span class="keyword">private</span> ScrollView mScrollView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HelloDjinni mHelloDjinniInterface = HelloDjinni.create();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mTextView = (TextView) findViewById(R.id.textView);</span><br><span class="line">        mScrollView = (ScrollView) findViewById(R.id.scrollView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onButtonClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        mTextView.append(mHelloDjinniInterface.getHelloDjinni() + <span class="string">"\n"</span>);</span><br><span class="line">        mScrollView.fullScroll(ScrollView.FOCUS_DOWN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><figcaption><span>project/android/HelloDjinni2/app/src/.../activity_main.xml</span><a href="https://github.com/joinAero/XCalculator/tree/master/sample/hellodjinni/project/android/HelloDjinni2/app/src/main/res/layout/activity_main.xml" target="_blank" rel="external">activity_main.xml</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span><br><span class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span><br><span class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span><br><span class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span><br><span class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span><br><span class="line">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span><br><span class="line">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span><br><span class="line">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span><br><span class="line">    <span class="attr">tools:context</span>=<span class="string">"cc.eevee.hellodjinni2.MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span><br><span class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></span><br><span class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span><br><span class="line">        <span class="attr">android:text</span>=<span class="string">"Get Hello Djinni!"</span></span><br><span class="line">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span><br><span class="line">        <span class="attr">android:onClick</span>=<span class="string">"onButtonClick"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span></span><br><span class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/scrollView"</span></span><br><span class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span><br><span class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span></span><br><span class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span><br><span class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>“Run &gt; Run ‘app’”运行项目。 UI 上”Get Hello Djinni!”的按钮，每点击下就会添加条从 C++ 返回的信息。</p>
<img src="/2016/05/06/using-djinni/android_pro2_result.png" width="300">
<h4 id="NDK-参考"><a href="#NDK-参考" class="headerlink" title="NDK 参考"></a>NDK 参考</h4><ul>
<li><a href="http://developer.android.com/ndk/guides/index.html" target="_blank" rel="external">NDK Guides</a></li>
<li><a href="http://tools.android.com/tech-docs/android-ndk-preview" target="_blank" rel="external">Android NDK Preview</a></li>
<li><a href="http://tools.android.com/tech-docs/new-build-system/gradle-experimental" target="_blank" rel="external">Experimental Plugin User Guide</a></li>
<li><a href="http://stackoverflow.com/questions/31979965/after-updating-android-studio-to-version-1-3-0-i-am-getting-ndk-integration-is" target="_blank" rel="external">Error: NDK integration is deprecated in the current plugin</a></li>
</ul>
<h2 id="结语：开始使用-Djinni-吧"><a href="#结语：开始使用-Djinni-吧" class="headerlink" title="结语：开始使用 Djinni 吧"></a>结语：开始使用 Djinni 吧</h2><h2 id="附：源码"><a href="#附：源码" class="headerlink" title="附：源码"></a>附：源码</h2><p>Hello Djinni 的源码，这样得到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/joinAero/XCalculator.git</span><br><span class="line">$ <span class="built_in">cd</span> sample/hellodjinni/</span><br></pre></td></tr></table></figure>
<p>修改<code>local.properties</code>设好环境。执行<code>make</code>编译，<code>make clean</code>清理。</p>
<p><strong>文件结构：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hellodjinni/</span><br><span class="line">├─project/</span><br><span class="line">│  ├─android/</span><br><span class="line">│  │  ├─HelloDjinni/                # Android Project with GYP &amp; ndk-build</span><br><span class="line">│  │  └─HelloDjinni2/               # Android Project with Experimental Plugin</span><br><span class="line">│  ├─cpp/</span><br><span class="line">│  │  └─HelloDjinni/                # Cpp Test Project</span><br><span class="line">│  └─ios/</span><br><span class="line">│      ├─HelloDjinni/</span><br><span class="line">│      └─HelloDjinni.xcworkspace/   # iOS Project Workspace</span><br><span class="line">├─src/</span><br><span class="line">│  └─cpp/                           # Cpp Interface Impls</span><br><span class="line">├─tools/                            # Helper Scripts</span><br><span class="line">└─local.properties                  # Local Properties</span><br></pre></td></tr></table></figure>
<h2 id="附：运行环境"><a href="#附：运行环境" class="headerlink" title="附：运行环境"></a>附：运行环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OS</span></span><br><span class="line">ProductName: Mac OS X ProductVersion: 10.11.4 BuildVersion: 15E65</span><br><span class="line"></span><br><span class="line"><span class="comment"># XCode</span></span><br><span class="line">Xcode 7.3.1 Build version 7D1014</span><br><span class="line"></span><br><span class="line"><span class="comment"># XCode 命令行工具</span></span><br><span class="line"><span class="comment"># xcode-select --install</span></span><br><span class="line">xcode-select version 2343.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Java</span></span><br><span class="line">java version <span class="string">"1.8.0_25"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_25-b17)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.25-b02, mixed mode)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Android Studio</span></span><br><span class="line"><span class="comment"># Android Studio &gt; About Android Studio</span></span><br><span class="line"><span class="comment"># Android Studio &gt; Appearance &amp; Behavior &gt; System Settings &gt; Updates</span></span><br><span class="line">Android Studio 2.1</span><br><span class="line">Build <span class="comment">#AI-143.2790544</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Android NDK</span></span><br><span class="line">GNU Make 3.81 Copyright (C) 2006 Free Software Foundation, Inc. This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions. There is NO warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. This program built <span class="keyword">for</span> i386-apple-darwin11.3.0</span><br></pre></td></tr></table></figure>
<p>如果未添加过 Android 环境变量，请于 ~/.bash_profile 文件内设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ANDROID_HOME=<span class="variable">$HOME</span>/Develop/android-sdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ANDROID_HOME</span>/tools:<span class="variable">$ANDROID_HOME</span>/platform-tools</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ANDROID_NDK_HOME=<span class="variable">$HOME</span>/Develop/android-ndk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ANDROID_NDK_HOME</span></span><br></pre></td></tr></table></figure>
<p>终端运行如下命令可立即生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>
<p>验证 SDK 与 NDK 命令行工具可用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">which</span> android</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">which</span> ndk-build</span><br></pre></td></tr></table></figure>
<p>验证 XCode 命令行工具可用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">which</span> xcrun</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">which</span> xcodebuild</span><br></pre></td></tr></table></figure>
<h2 id="附：参考内容"><a href="#附：参考内容" class="headerlink" title="附：参考内容"></a>附：参考内容</h2><ul>
<li><a href="http://mobilecpptutorials.com/your-first-cross-platform-djinni-app-part-1-cplusplus/" target="_blank" rel="external">Your First Cross-Platform Djinni App</a></li>
<li><a href="http://www.infoq.com/cn/news/2014/06/dropbox-cpp-crossplatform-mobile/" target="_blank" rel="external">iOS和Android的C++跨平台开发 | Dropbox</a></li>
</ul>
<!--
Projects:

* [djinni | dropbox](https://github.com/dropbox/djinni)
* [android-ndk | googlesamples](https://github.com/googlesamples/android-ndk.git)

References:

* [Cpp Reference](http://en.cppreference.com)
* [NDK API Reference](http://developer.android.com/ndk/reference/index.html)
* [iOS Developer Library](https://developer.apple.com/library/ios)
* [Mac Developer Library](https://developer.apple.com/library/mac)

Extra Articles:

* [From C++ to Objective-C](http://pierre.chachatelier.fr/programmation/fichiers/cpp-objc-2_1-en.pdf)

Extra Tools:

* [sbt](http://www.scala-sbt.org/index.html): `brew install sbt`
* [sbt下载慢？](http://www.zhihu.com/question/31158252)
-->

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="Eevee" />
          <p class="site-author-name" itemprop="name">Eevee</p>
          <p class="site-description motion-element" itemprop="description">A full belly conquers all.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/joinAero" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/joinAero" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eevee</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"eevee"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  





  
  
  

  

  

</body>
</html>
